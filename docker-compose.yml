version: '3.8'

services:
  # --- 1. Database: PostgreSQL ---
  postgres:
    image: postgres:16-alpine
    container_name: life_os_db
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: adminpassword
      POSTGRES_DB: life_os_db
    ports:
      - "5433:5432" # Changed to 5433 to avoid port conflict
    volumes:
      - ./docker-data/postgres:/var/lib/postgresql/data

  # --- 2. Storage: MinIO (S3 Compatible) ---
  minio:
    image: minio/minio
    container_name: life_os_storage
    command: server /data --console-address ":9001"
    restart: always
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console UI Port
    volumes:
      - ./docker-data/minio:/data

  # --- 3. Vector DB: Qdrant (Cho AI/Machine Learning) ---
  qdrant:
    image: qdrant/qdrant
    container_name: life_os_vector_db
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - ./docker-data/qdrant:/qdrant/storage

  # --- 4. Backend: NestJS (Sẽ setup code ở bước sau) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: life_os_backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - minio
    environment:
      DATABASE_URL: postgres://admin:adminpassword@postgres:5432/life_os_db
      MINIO_ENDPOINT: minio
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin

  # --- 5. Frontend: Next.js (Sẽ setup code ở bước sau) ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: life_os_frontend
    restart: unless-stopped
    ports:
      - "3001:3000" # Map cổng 3000 của Nextjs ra cổng 3001 máy thật
    depends_on:
      - backend

  # --- 6. AI Service: Python (Sẽ setup code ở bước sau) ---
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: life_os_ai
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      - qdrant
      - postgres
